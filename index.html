<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 50px;
            text-align: center;
        }
        input {
            margin: 10px;
            padding: 10px;
        }
        #message {
            margin-top: 20px;
            font-weight: bold;
            color: red;
        }
    </style>
    <script src="https://unpkg.com/@supabase/supabase-js@2.46.1/dist/umd/supabase.js"></script>
    <script>
        // Initialize the Supabase client (API key will be included in URL)
        const supabaseUrl = 'https://bovufdtlrhhcdrfsfmtb.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJvdnVmZHRscmhoY2RyZnNmbXRiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzIxNDg1NjQsImV4cCI6MjA0NzcyNDU2NH0.rfo5aNmeekEcGb8g8Wtq7rTATzfwyvyYckeWbUJQ3f8';  // Replace with your actual API key

        async function login() {
            const username = document.getElementById('name').value;
            const password = document.getElementById('password').value;

            if (!username || !password) {
                alert('Please enter both username and password!');
                return;
            }

            try {
                // Check if deviceId exists in sessionStorage
                let deviceId = sessionStorage.getItem('device_id');
                if (!deviceId) {
                    // If deviceId is not in sessionStorage, generate a new one
                    deviceId = generateDeviceId();
                    sessionStorage.setItem('device_id', deviceId); // Store the device ID in sessionStorage
                }

                // Check if the user exists in the database
                const response = await fetch(`${supabaseUrl}/rest/v1/users?username=eq.${username}&password=eq.${password}&apikey=${supabaseKey}`);
                
                if (!response.ok) {
                    throw new Error(`Failed to fetch users: ${response.statusText}`);
                }

                // Attempt to parse the response
                let data;
                try {
                    data = await response.json();
                } catch (error) {
                    throw new Error('Failed to parse JSON response: ' + error.message);
                }

                // Check if response is valid and users array is present
                if (Array.isArray(data) && data.length > 0) {
                    const user = data[0];

                    // If the deviceId already exists, allow login
                    if (user.device_id === deviceId) {
                        alert('Logged in successfully!');
                        // Store the user credentials in sessionStorage for future reference
                        sessionStorage.setItem('username', username);
                        sessionStorage.setItem('password', password);
                        window.location.href = "Website.html";
                    } else {
                        // Device ID doesn't match, update it
                        await updateDeviceId(user.id, deviceId);
                        alert('Device ID updated successfully!');
                        window.location.href = "Website.html";
                    }
                } else {
                    // New user, create a new account
                    await createUser(username, password, deviceId);
                    alert('Welcome, new user!');
                    window.location.href = "Website.html";

                    // Store the new user's information in sessionStorage
                    sessionStorage.setItem('username', username);
                    sessionStorage.setItem('password', password);
                }
            } catch (err) {
                console.error('Error during login:', err);
            }
        }

        function generateDeviceId() {
            return Math.random().toString(36).substr(2, 9);  // Generates a random device ID
        }

        async function createUser(username, password, deviceId) {
            const response = await fetch(`${supabaseUrl}/rest/v1/users?apikey=${supabaseKey}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify([
                    { username, password, device_id: deviceId }
                ])
            });

            const result = await response.json();
            if (result.error) {
                console.error('Error creating user:', result.error);
            }
        }

        async function updateDeviceId(userId, deviceId) {
            const response = await fetch(`${supabaseUrl}/rest/v1/users?id=eq.${userId}&apikey=${supabaseKey}`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    device_id: deviceId
                })
            });

            const result = await response.json();
            if (result.error) {
                console.error('Error updating device ID:', result.error);
            }
        }

        window.onload = function() {
            const storedUsername = sessionStorage.getItem('username');
            const storedPassword = sessionStorage.getItem('password');
            const storedDeviceId = sessionStorage.getItem('device_id');

            if (storedUsername && storedPassword && storedDeviceId) {
                console.log('Logged in as: ' + storedUsername);
                console.log('Password: ' + storedPassword);
                console.log('Device ID: ' + storedDeviceId);
            }
        }
    </script>
</head>
<body>
    <h1>What is your name?</h1>
    <input type="text" id="name" placeholder="Enter your name" required>
    <input type="password" id="password" placeholder="Enter password (if needed)">
    <button onclick="login()">Check!</button>
    <div id="message"></div>
</body>
</html>
