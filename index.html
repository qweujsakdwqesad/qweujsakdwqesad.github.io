<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 50px;
            text-align: center;
        }
        input {
            margin: 10px;
            padding: 10px;
            width: 80%;
        }
        #message {
            margin-top: 20px;
            font-weight: bold;
            color: red;
        }
    </style>
    <!-- Supabase Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <!-- Custom Script -->
    <script>
        let supabase; // Declare supabase globally to initialize later

        function initializeSupabase() {
            return new Promise((resolve) => {
                const interval = setInterval(() => {
                    if (window.supabase) {
                        clearInterval(interval); // Stop checking once Supabase is available
                        resolve();
                    }
                }, 50); // Check every 50ms
            });
        }

        async function startApp() {
            await initializeSupabase();

            const SUPABASE_URL = "https://bovufdtlrhhcdrfsfmtb.supabase.co";
            const SUPABASE_API_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJvdnVmZHRscmhoY2RyZnNmbXRiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzIxNDg1NjQsImV4cCI6MjA0NzcyNDU2NH0.rfo5aNmeekEcGb8g8Wtq7rTATzfwyvyYckeWbUJQ3f8";

            // Initialize Supabase client
            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_API_KEY);

            console.log("Supabase initialized successfully!");
        }

        async function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            if (!username || !password) {
                document.getElementById('message').innerText = "Please fill in all fields.";
                return;
            }

            try {
                // Ensure device ID is in localStorage
                let deviceId = localStorage.getItem('device_id');
                if (!deviceId) {
                    deviceId = generateDeviceId();
                    localStorage.setItem('device_id', deviceId);
                }

                // Fetch user data from Supabase
                const { data: userData, error } = await supabase
                    .from('users')
                    .select('*')
                    .eq('username', username)
                    .eq('password', password);

                if (error || !userData || userData.length === 0) {
                    document.getElementById('message').innerText = "Invalid username or password.";
                    return;
                }

                const user = userData[0];

                // Check if the device ID matches
                if (user.device_id && user.device_id !== deviceId) {
                    // Ban the user
                    await supabase.from('banned_users').insert([{ device_id: deviceId }]);
                    document.getElementById('message').innerText = "Device banned.";
                    localStorage.removeItem('device_id');
                    setTimeout(() => window.location.reload(), 2000);
                    return;
                }

                // If no device ID is set, update it in Supabase
                if (!user.device_id) {
                    const { error: updateError } = await supabase
                        .from('users')
                        .update({ device_id: deviceId })
                        .eq('username', username);

                    if (updateError) {
                        document.getElementById('message').innerText = "Failed to update device ID.";
                        return;
                    }
                }

                // Login successful
                document.getElementById('message').innerText = "Login successful!";
                localStorage.setItem('username', username);
                localStorage.setItem('password', password);
                setTimeout(() => window.location.href = "Website.html", 1000);
            } catch (error) {
                console.error("Error during login:", error);
                document.getElementById('message').innerText = "An error occurred during login.";
            }
        }


        function generateDeviceId() {
            return 'device-' + Math.random().toString(36).substr(2, 10);
        }

        // Initialize the app
        startApp();
    </script>
</head>
<body>
    <h1>Login</h1>
    <input type="text" id="username" placeholder="Enter your username">
    <input type="password" id="password" placeholder="Enter your password">
    <input type="submit" value="Login" onclick="login()">
    <div id="message"></div>
</body>
</html>
